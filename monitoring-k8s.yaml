apiVersion: v1
kind: Namespace
metadata:
  name: monitoring

---
# ==========================================
# 1. é…ç½®ç®¡ç† (ConfigMaps)
# ==========================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']
      
      # ç›‘æ§æ‰€æœ‰èŠ‚ç‚¹çš„ Node Exporter
      - job_name: 'node-exporter'
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
        - source_labels: [__meta_kubernetes_service_label_app]
          regex: node-exporter
          action: keep
        - source_labels: [__meta_kubernetes_endpoint_port_name]
          regex: metrics
          action: keep

      # ç›‘æ§ Kubelet (æ›¿ä»£ cAdvisor)
      # æ³¨æ„ï¼šåœ¨ K3s ä¸­å¯èƒ½éœ€è¦æ ¹æ®å…·ä½“å®‰å…¨é…ç½®è°ƒæ•´ token æˆ– scheme
      - job_name: 'kubernetes-nodes-cadvisor'
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - target_label: __address__
          replacement: kubernetes.default.svc:443
        - source_labels: [__meta_kubernetes_node_name]
          regex: (.+)
          target_label: __metrics_path__
          replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
      
      # [æ–°å¢] ç›‘æ§ Jetson GPU/åŠŸè€—/æ¸©åº¦ (JTOP)
      - job_name: 'jetson-jtop'
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
        - source_labels: [__meta_kubernetes_service_label_app]
          regex: jetson-exporter
          action: keep
        - source_labels: [__meta_kubernetes_endpoint_port_name]
          regex: metrics
          action: keep
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-html
  namespace: monitoring
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Edge Cluster Monitoring Center</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }
            .container { max-width: 1200px; margin: 0 auto; }
            h1 {
                text-align: center; color: white; margin-bottom: 40px;
                font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }
            .grid {
                display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }
            .card {
                background: white; border-radius: 15px; padding: 25px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                transition: transform 0.3s, box-shadow 0.3s;
                display: flex; flex-direction: column;
            }
            .card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); }
            .card h2 { color: #667eea; margin-bottom: 10px; font-size: 1.5em; display: flex; align-items: center; justify-content: space-between; }
            .card p { color: #666; margin-bottom: 15px; line-height: 1.6; flex-grow: 1; }
            .card a {
                display: inline-block; text-align: center;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white; padding: 10px 20px; border-radius: 8px;
                text-decoration: none; font-weight: 600; transition: opacity 0.3s;
            }
            .card a:hover { opacity: 0.9; }
            .port {
                display: inline-block; background: #f0f0f0; padding: 3px 8px;
                border-radius: 4px; font-size: 0.6em; color: #666; vertical-align: middle;
            }
            .tag {
                font-size: 0.5em; padding: 2px 6px; border-radius: 4px; color: white; vertical-align: middle; margin-left: 5px;
            }
            .tag-pi { background-color: #c51a4a; }
            .tag-jetson { background-color: #76b900; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸŒŒ Edge Cluster Monitoring Center</h1>
            <div class="grid">
                <div class="card">
                    <h2>ğŸ“Š Grafana</h2>
                    <p>Data visualization platform, dashboards for all nodes.<span class="port">:30300</span></p>
                    <p><strong>User:</strong> admin / admin</p>
                    <a href="#" onclick="visit(30300)">Open Grafana</a>
                </div>

                <div class="card">
                    <h2>ğŸ“ˆ Prometheus</h2>
                    <p>Time-series database and collector.<span class="port">:30090</span></p>
                    <a href="#" onclick="visit(30090)">Open Prometheus</a>
                </div>

                <div class="card">
                    <h2>ğŸ³ Portainer</h2>
                    <p>Kubernetes cluster management UI.<span class="port">:30009</span></p>
                    <a href="#" onclick="visit(30009)">Open Portainer</a>
                </div>

                <div class="card">
                    <h2>ğŸš€ Jetson Stats <span class="tag tag-jetson">Orin Nano</span></h2>
                    <p>NVIDIA GPU, Power, Fan & Thermal metrics.<span class="port">:9800</span></p>
                    <p style="font-size: 0.9em; color: #888">Raw Metrics endpoint</p>
                    <a href="#" onclick="visit(9800, '/metrics')">View JTOP Metrics</a>
                </div>

                <div class="card">
                    <h2>ğŸ–¥ï¸ Node Exporter <span class="tag tag-pi">All Nodes</span></h2>
                    <p>Standard Linux hardware metrics (CPU/Mem/Disk).<span class="port">:9100</span></p>
                    <a href="#" onclick="visit(9100, '/metrics')">View Raw Metrics</a>
                </div>
            </div>
        </div>

        <script>
            // è‡ªåŠ¨ä½¿ç”¨å½“å‰æµè§ˆå™¨åœ°å€æ çš„ IP
            function visit(port, path = '') {
                const host = window.location.hostname;
                const protocol = window.location.protocol;
                const url = `${protocol}//${host}:${port}${path}`;
                window.open(url, '_blank');
            }
        </script>
    </body>
    </html>
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: monitoring
data:
  default.conf: |
    server {
        listen 80;
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
        }
    }

---
# ==========================================
# 2. Portainer (K8s ç®¡ç†é¢æ¿)
# ==========================================
# Portainer åœ¨ K8s ä¸­éœ€è¦ RBAC æƒé™æ‰èƒ½ç®¡ç†é›†ç¾¤
apiVersion: v1
kind: ServiceAccount
metadata:
  name: portainer-sa
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: portainer-rb
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: portainer-sa
  namespace: monitoring
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: portainer
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: portainer
  template:
    metadata:
      labels:
        app: portainer
    spec:
      serviceAccountName: portainer-sa
      containers:
      - name: portainer
        # æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»ä½¿ç”¨ Portainer CE ç‰ˆï¼ŒåŸ Docker ç‰ˆä¸åŒ…å« K8s æ”¯æŒ
        image: portainer/portainer-ce:latest
        ports:
        - containerPort: 9000
        - containerPort: 9443
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {} # ç”Ÿäº§ç¯å¢ƒè¯·æ”¹ä¸º PVC
---
apiVersion: v1
kind: Service
metadata:
  name: portainer
  namespace: monitoring
spec:
  type: NodePort
  ports:
  - port: 9000
    targetPort: 9000
    nodePort: 30009 # è®¿é—®ç«¯å£: 30009
    name: http
  - port: 9443
    targetPort: 9443
    nodePort: 30943
    name: https
  selector:
    app: portainer

---
# ==========================================
# 3. Prometheus (ç›‘æ§æ ¸å¿ƒ)
# ==========================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      serviceAccountName: portainer-sa # å¤ç”¨æƒé™ä»¥ä¾¿é€šè¿‡ SD å‘ç°èŠ‚ç‚¹
      containers:
      - name: prometheus
        image: prom/prometheus:latest
        args:
          - "--config.file=/etc/prometheus/prometheus.yml"
          - "--storage.tsdb.path=/prometheus"
          - "--storage.tsdb.retention.time=15d"
        ports:
        - containerPort: 9090
        volumeMounts:
        - name: config
          mountPath: /etc/prometheus/prometheus.yml
          subPath: prometheus.yml
        - name: data
          mountPath: /prometheus
      volumes:
      - name: config
        configMap:
          name: prometheus-config
      - name: data
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: monitoring
spec:
  type: NodePort
  ports:
  - port: 9090
    targetPort: 9090
    nodePort: 30090 # è®¿é—®ç«¯å£: 30090
  selector:
    app: prometheus

---
# ==========================================
# 4. Grafana (å¯è§†åŒ–)
# ==========================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:latest
        ports:
        - containerPort: 3000
        env:
        - name: GF_SECURITY_ADMIN_USER
          value: "admin"
        - name: GF_SECURITY_ADMIN_PASSWORD
          value: "admin"
        volumeMounts:
        - name: data
          mountPath: /var/lib/grafana
      volumes:
      - name: data
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
spec:
  type: NodePort
  ports:
  - port: 3000
    targetPort: 3000
    nodePort: 30300 # è®¿é—®ç«¯å£: 30300
  selector:
    app: grafana

---
# ==========================================
# 5. Node Exporter (DaemonSet - æ¯å°æœºå™¨è·‘ä¸€ä¸ª)
# ==========================================
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-exporter
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: node-exporter
  template:
    metadata:
      labels:
        app: node-exporter
    spec:
      hostNetwork: true
      hostPID: true
      containers:
      - name: node-exporter
        image: prom/node-exporter:latest
        args:
          - "--path.rootfs=/host"
        ports:
        - containerPort: 9100
          name: metrics
        volumeMounts:
        - name: root
          mountPath: /host
          readOnly: true
      volumes:
      - name: root
        hostPath:
          path: /
---
apiVersion: v1
kind: Service
metadata:
  name: node-exporter
  namespace: monitoring
  labels:
    app: node-exporter
spec:
  clusterIP: None
  ports:
  - port: 9100
    name: metrics
  selector:
    app: node-exporter

---
# ==========================================
# 6. RPi Temp Exporter (DaemonSet)
# ==========================================
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: rpi-exporter
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: rpi-exporter
  template:
    metadata:
      labels:
        app: rpi-exporter
    spec:
      containers:
      - name: rpi-exporter
        image: carlosedp/arm_exporter:latest
        securityContext:
          privileged: true
        ports:
        - containerPort: 9243
        volumeMounts:
        - name: sys
          mountPath: /sys
          readOnly: true
        - name: hostname
          mountPath: /etc/nodename
          readOnly: true
      volumes:
      - name: sys
        hostPath:
          path: /sys
      - name: hostname
        hostPath:
          path: /etc/hostname
---
apiVersion: v1
kind: Service
metadata:
  name: rpi-exporter
  namespace: monitoring
spec:
  clusterIP: None
  ports:
  - port: 9243
  selector:
    app: rpi-exporter

---
# ==========================================
# 7. Jetson JTOP Exporter (Jetsonä¸“ç”¨)
# ==========================================
# è¯¥å®¹å™¨è¯»å–å®¿ä¸»æœºçš„ jtop.sock å¹¶è½¬åŒ–ä¸º Prometheus æ ¼å¼
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: jetson-exporter
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: jetson-exporter
  template:
    metadata:
      labels:
        app: jetson-exporter
    spec:
      # å…³é”®ï¼šåªè°ƒåº¦åˆ°æ‰“äº†æ ‡ç­¾ hardware=jetson çš„èŠ‚ç‚¹ä¸Š
      hostNetwork: true
      nodeSelector:
        hardware: jetson
      containers:
      - name: jetson-exporter
        image: local/jetson-exporter:v1
        imagePullPolicy: Never
        securityContext:
          privileged: true
        ports:
        - containerPort: 9800
          name: metrics
        volumeMounts:
        - name: jtop-socket
          mountPath: /run/jtop.sock
          readOnly: true
      volumes:
      - name: jtop-socket
        hostPath:
          path: /run/jtop.sock
          type: Socket
---
apiVersion: v1
kind: Service
metadata:
  name: jetson-exporter
  namespace: monitoring
  labels:
    app: jetson-exporter
spec:
  clusterIP: None
  ports:
  - port: 9800
    name: metrics
  selector:
    app: jetson-exporter

---
# ==========================================
# 8. Nginx (Web åº”ç”¨)
# ==========================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        resources:
          limits:
            memory: 64Mi
        volumeMounts:
        - name: html-volume
          mountPath: /usr/share/nginx/html/index.html
          subPath: index.html
        - name: config-volume
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
      volumes:
      - name: html-volume
        configMap:
          name: nginx-html
      - name: config-volume
        configMap:
          name: nginx-config
---
apiVersion: v1
kind: Service
metadata:
  name: nginx
  namespace: monitoring
spec:
  type: NodePort
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080 # è®¿é—®ç«¯å£: 30080
  selector:
    app: nginx